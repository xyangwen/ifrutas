<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iFrutas - As Melhores Frutas do Rio</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ea1d2c;
            --primary-dark: #b60f1b;
            --bg: #f7f7f7;
            --text: #3e3e3e;
            --text-light: #717171;
            --white: #ffffff;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: var(--text); padding-bottom: 90px; }

        /* --- Header & Endere√ßo --- */
        header {
            background: var(--white);
            padding: 15px 20px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-bar {
            cursor: pointer;
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .location-label { font-size: 0.8rem; color: var(--primary); font-weight: bold; text-transform: uppercase; margin-bottom: 2px; }
        .location-address { font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; color: var(--text); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 90vw; }
        .location-address::after { content: '‚ñº'; font-size: 0.7rem; color: var(--primary); margin-left: 5px; }

        .app-title {
            color: var(--primary);
            font-weight: 900;
            font-size: 1.2rem;
            text-align: center;
            width: 100%;
            margin-top: 10px;
            letter-spacing: -0.5px;
        }

        /* --- Cat√°logo --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        h2 { font-size: 1.1rem; margin-bottom: 15px; font-weight: 700; color: #333; }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }

        @media(min-width: 768px) {
            .product-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; }
        }

        .product-card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
        }

        .product-card:hover { transform: translateY(-2px); }

        .product-img {
            width: 100%;
            height: 140px;
            object-fit: cover;
        }

        .product-info { padding: 12px; flex: 1; display: flex; flex-direction: column; }
        .product-title { font-size: 0.95rem; font-weight: 500; margin-bottom: 5px; line-height: 1.2; }
        .product-desc-short { font-size: 0.8rem; color: var(--text-light); margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .product-meta { margin-top: auto; display: flex; justify-content: space-between; align-items: center; }
        .product-price { color: #50a773; font-weight: 500; }
        .delivery-time { font-size: 0.75rem; color: var(--text-light); }

        /* --- Modais (Overlay) --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; justify-content: center; align-items: flex-end;
        }
        
        @media(min-width: 768px) {
            .modal { align-items: center; }
            .modal-content { max-width: 500px !important; border-radius: 12px !important; height: auto !important; max-height: 90vh; }
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--white);
            width: 100%;
            height: auto;
            max-height: 95%;
            border-radius: 16px 16px 0 0;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .close-btn {
            position: absolute; top: 15px; right: 15px;
            background: #eee; border: none; width: 30px; height: 30px;
            border-radius: 50%; cursor: pointer; font-weight: bold; color: #555; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center; z-index: 10;
        }

        /* --- Detalhes do Produto --- */
        .detail-img { width: 100%; height: 200px; object-fit: cover; border-radius: var(--radius); margin-bottom: 15px; }
        .detail-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; }
        .detail-price { color: #50a773; font-size: 1.2rem; font-weight: 500; margin-bottom: 15px; }
        .benefit-box { background: #fff8f8; border: 1px solid #ffebeb; padding: 12px; border-radius: var(--radius); margin-bottom: 15px; }
        .benefit-title { color: var(--primary); font-weight: bold; font-size: 0.9rem; display: block; margin-bottom: 5px; }
        
        textarea {
            width: 100%; border: 1px solid #ddd; border-radius: var(--radius);
            padding: 12px; font-family: inherit; margin-bottom: 20px; resize: none; outline: none;
        }
        textarea:focus { border-color: var(--primary); }

        .action-bar {
            margin-top: auto; border-top: 1px solid #eee; padding-top: 15px;
            display: flex; justify-content: space-between; align-items: center; gap: 10px;
        }
        
        .counter { display: flex; align-items: center; gap: 15px; border: 1px solid #ddd; padding: 10px 15px; border-radius: var(--radius); }
        .counter button { border: none; background: none; color: var(--primary); font-size: 1.5rem; cursor: pointer; font-weight: bold; }
        
        .btn-primary {
            flex: 1; background: var(--primary); color: white; border: none;
            padding: 16px; border-radius: var(--radius); font-weight: 500; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; font-size: 1rem;
        }
        .btn-primary:active { background: var(--primary-dark); transform: scale(0.98); }
        .btn-outline {
            width: 100%; background: white; color: var(--primary); border: 1px solid var(--primary);
            padding: 12px; border-radius: var(--radius); font-weight: 500; cursor: pointer; margin-top: 10px;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- Formul√°rios --- */
        .form-group { margin-bottom: 12px; }
        .form-label { display: block; font-size: 0.8rem; color: var(--text-light); margin-bottom: 4px; font-weight: 500; }
        .form-input { 
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; 
            outline: none; transition: border 0.2s; font-size: 1rem;
        }
        .form-input:focus { border-color: var(--primary); }
        
        .form-row { display: flex; gap: 10px; }
        .form-col-half { flex: 1; }
        .form-col-third { flex: 0 0 30%; }

        /* --- Carrinho e Checkout --- */
        .cart-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--white); border-top: 1px solid #eee; padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 90;
            display: flex; justify-content: space-between; align-items: center;
        }
        .hidden { display: none !important; }

        /* --- Pagamento --- */
        .pix-area { text-align: center; margin-top: 20px; }
        .pix-logo { height: 25px; margin-bottom: 10px; }
        .qr-code { width: 180px; height: 180px; margin: 15px auto; border: 1px solid #ddd; padding: 5px; border-radius: 4px; }
        .timer { color: var(--primary); font-weight: bold; margin: 10px 0; font-size: 1.4rem; font-family: monospace; }
        
        /* --- Telas de Carregamento e Sucesso --- */
        .full-screen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--primary); color: white;
            z-index: 2000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }

        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .success-icon { font-size: 5rem; margin-bottom: 10px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <header onclick="openAddressModal()">
        <div class="location-bar">
            <span class="location-label">ENTREGAR EM</span>
            <span class="location-address" id="header-address">Selecionar Endere√ßo</span>
        </div>
    </header>
    <div class="app-title">iFrutas üçé</div>

    <main class="container">
        <h2>Destaques da Regi√£o üìç</h2>
        <div class="product-grid" id="product-list">
            </div>
    </main>

    <div class="cart-bar hidden" id="cart-bar">
        <div>
            <p style="font-size: 0.8rem; color: #717171;">Total sem entrega</p>
            <p style="font-weight: bold; font-size: 1.1rem;" id="cart-bar-total">R$ 0,00</p>
        </div>
        <button class="btn-primary" style="flex: 0 0 auto; width: 140px; justify-content: center;" onclick="openCartModal()">
            Ver Sacola
        </button>
    </div>

    <div class="modal" id="product-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('product-modal')">√ó</button>
            <img src="" alt="" class="detail-img" id="modal-img">
            <h3 class="detail-title" id="modal-title"></h3>
            <p class="detail-price" id="modal-price"></p>
            
            <div class="benefit-box">
                <span class="benefit-title">‚ú® Benef√≠cios e Informa√ß√µes</span>
                <p id="modal-benefits" style="font-size: 0.85rem; color: #555; line-height: 1.4;"></p>
            </div>

            <div style="margin-bottom: 20px; font-size: 0.85rem; color: #717171; display: flex; align-items: center; gap: 5px;">
                <span>üõµ</span> <span id="modal-delivery-time"></span> ‚Ä¢ Entregador pr√≥ximo
            </div>

            <label style="font-weight: 500; margin-bottom: 8px; display: block; font-size: 0.9rem;">Alguma observa√ß√£o?</label>
            <textarea id="modal-obs" placeholder="Ex: Tirar o caro√ßo, escolher bem madura..."></textarea>

            <div class="action-bar">
                <div class="counter">
                    <button onclick="changeQty(-1)">-</button>
                    <span id="modal-qty" style="font-weight: bold; min-width: 20px; text-align: center;">1</span>
                    <button onclick="changeQty(1)">+</button>
                </div>
                <button class="btn-primary" onclick="addToCart()">
                    <span>Adicionar</span>
                    <span id="modal-btn-price"></span>
                </button>
            </div>
        </div>
    </div>

    <div class="modal" id="cart-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('cart-modal')">√ó</button>
            <h3 style="margin-bottom: 20px;">Sua Sacola</h3>
            <div id="cart-items-container" style="flex: 1; overflow-y: auto;">
                </div>
            
            <div style="border-top: 1px solid #eee; padding-top: 15px; margin-top: auto;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <strong>Total</strong>
                    <strong id="cart-total-display">R$ 0,00</strong>
                </div>
                <button class="btn-outline" onclick="clearCart()" style="margin-bottom: 10px; border-color: #ddd; color: #666;">Esvaziar Sacola</button>
                <button class="btn-primary" style="width: 100%; justify-content: center;" onclick="goToCheckout()">Continuar para Pagamento</button>
            </div>
        </div>
    </div>

    <div class="modal" id="address-modal">
        <div class="modal-content" style="height: auto;">
            <button class="close-btn" onclick="closeModal('address-modal')">√ó</button>
            <h3>Endere√ßo de Entrega üè†</h3>
            <p style="font-size: 0.85rem; color: #777; margin-bottom: 20px;">Seus dados ficam salvos automaticamente.</p>
            
            <div style="margin-top: 10px;">
                <div class="form-group">
                    <label class="form-label">Nome Completo</label>
                    <input type="text" id="user-name" class="form-input" placeholder="Ex: Maria Silva">
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label class="form-label">Rua / Avenida</label>
                        <input type="text" id="addr-street" class="form-input" placeholder="Ex: Av. Atl√¢ntica">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label">N√∫mero</label>
                        <input type="text" id="addr-num" class="form-input" placeholder="123">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Complemento (Opcional)</label>
                    <input type="text" id="addr-comp" class="form-input" placeholder="Ex: Apt 101, Bloco B">
                </div>

                <div class="form-group">
                    <label class="form-label">Ponto de Refer√™ncia</label>
                    <input type="text" id="addr-ref" class="form-input" placeholder="Ex: Ao lado da padaria">
                </div>

                <button class="btn-primary" style="width: 100%; justify-content: center; margin-top: 10px;" onclick="saveAddress()">Salvar Endere√ßo</button>
            </div>
        </div>
    </div>

    <div class="modal" id="checkout-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('checkout-modal')">√ó</button>
            <h3>Finalizar Pedido</h3>
            
            <div style="margin: 20px 0; background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
                <p style="margin-bottom: 5px;"><strong>üìç Entregar em:</strong></p>
                <p id="checkout-address-display" style="color: #555; font-size: 0.95rem; line-height: 1.4;">...</p>
                <div style="margin-top: 10px; border-top: 1px dashed #ddd; padding-top: 5px;">
                    <p style="font-size: 0.85rem; color: #777;">Para: <span id="checkout-name-display" style="font-weight: bold; color: #333;">...</span></p>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                    <p><strong>üõí Resumo:</strong></p>
                    <p style="font-weight: bold; font-size: 1.1rem;" id="checkout-total-display"></p>
                </div>
                <div id="checkout-items-summary" style="font-size: 0.85rem; color: #777; margin-top: 5px;"></div>
            </div>

            <div class="pix-area">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Logo%E2%80%94pix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg/2560px-Logo%E2%80%94pix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg.png" alt="Pix" class="pix-logo">
                <p style="font-size: 0.9rem;">Escaneie ou copie o c√≥digo abaixo</p>
                
                <img id="pix-qr-img" src="" class="qr-code" alt="QR Code Pix">
                
                <div class="timer" id="payment-timer">10:00</div>
                
                <button class="btn-primary" style="width: 100%; justify-content: center; margin-bottom: 10px;" onclick="copyPixCode()">
                    üìã Copiar C√≥digo Pix
                </button>
                
                <a id="payment-link-btn" href="#" target="_blank" class="btn-outline" style="display: block; text-align: center; text-decoration: none;" onclick="clickPaymentLink()">
                    üîó Link de Pagamento (Nubank)
                </a>
                
                <p style="font-size: 0.75rem; color: #888; margin-top: 15px; line-height: 1.3;">
                    ‚ö†Ô∏è Ap√≥s pagar, retorne a esta tela. O pedido ser√° confirmado automaticamente ap√≥s alguns segundos.
                </p>
            </div>
        </div>
    </div>

    <div class="full-screen-overlay hidden" id="loading-screen">
        <div class="spinner"></div>
        <h3>Confirmando Pagamento...</h3>
        <p>Validando transa√ß√£o Pix</p>
    </div>

    <div class="full-screen-overlay hidden" id="success-screen" style="background: #ffffff; color: #3e3e3e;">
        <div class="success-icon">‚úÖ</div>
        <h2 style="color: #ea1d2c; margin-bottom: 10px;">Pedido Confirmado!</h2>
        <p>Seu pedido j√° est√° sendo preparado.</p>
        
        <div style="margin-top: 30px; background: #f9f9f9; padding: 20px; border-radius: 12px; width: 80%; max-width: 300px;">
            <p style="font-size: 0.9rem; color: #777; margin-bottom: 5px;">Tempo estimado</p>
            <p style="font-size: 1.5rem; font-weight: bold; color: #333;"><span id="final-delivery-time"></span> min</p>
        </div>

        <button class="btn-outline" style="margin-top: 40px; width: 200px;" onclick="location.reload()">Voltar ao In√≠cio</button>
    </div>

    <script>
        // --- Dados ---
        const products = [
            {
                id: 1,
                name: "Jaca Dura Premium",
                price: 20.00,
                images: [
                    "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRav5c9icx32NBrS6E--h_GOloEZH_vZcvOf4VTc_zLxEPDLGHzHbi3VOw&s=10",
                    "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ_XdABlgSDGXxdX0dXmZ-x60mt_3bhVHzdmzAPFfGqWHAUDk0RFCrFLt0&s=10",
                    "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQNfE8FJ3-0MvKA6jtEsdNNg7POdF4rf3-dTPbjCXNi35KHwl_UJXZ__sSc&s=10"
                ],
                benefits: "Rica em fibras e energia. A Jaca Dura possui gominhos firmes, crocantes e sabor inigual√°vel. Fonte de Vitamina A e C.",
                deliveryRange: [20, 50]
            },
            {
                id: 2,
                name: "Jaca Mole Selecionada",
                price: 20.00,
                images: [
                    "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSZDNoz0ZN-3wuE8PQPN8oG0WK7dPcbTiCJ3J0w7eFIQbMMgBOyIKLJDss&s=10",
                    "https://images.tcdn.com.br/img/img_prod/1017342/muda_de_jaca_mole_enxertada_201_2_c5fbd1e5308815d0bf9bb6b6767fa2e4.jpg"
                ],
                benefits: "Textura cremosa e adocicada. A Jaca Mole √© perfeita para doces ou consumo in natura. Rica em antioxidantes.",
                deliveryRange: [20, 45]
            }
        ];

        const pixCode = "00020126580014BR.GOV.BCB.PIX01361c729f04-a046-4310-bdf5-1ead5d34bfc5520400005303986540520.005802BR5925Wendel dos Santos Oliveir6009SAO PAULO621405100JMyqeB0Mz630473B5";
        const pixLink = "https://nubank.com.br/cobrar/1ku07b/693b9dab-a751-438b-9db5-871e056167c6";

        // --- Estado Global ---
        let cart = [];
        let currentProduct = null;
        let currentQty = 1;
        
        // Estrutura de dados do usu√°rio atualizada
        let userData = {
            name: "",
            street: "",
            number: "",
            comp: "",
            ref: "",
            formatted: ""
        };

        let timerInterval;
        
        // Variaveis para l√≥gica de pagamento (Visibility API)
        let isPaymentPending = false;
        let leftAppTimestamp = 0;

        // --- Inicializa√ß√£o ---
        document.addEventListener('DOMContentLoaded', () => {
            renderProducts();
            loadUserData(); // Carregar dados salvos
            
            // Gerar QR Code
            document.getElementById('pix-qr-img').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(pixCode)}`;
            document.getElementById('payment-link-btn').href = pixLink;
            
            // Se n√£o tiver endere√ßo, pede.
            setTimeout(() => {
                if(!userData.formatted) openAddressModal();
            }, 1000);

            // Listener para Visibility Change (Sair e voltar da aba)
            document.addEventListener("visibilitychange", handleVisibilityChange);
        });

        // --- Persist√™ncia de Dados (LocalStorage) ---
        function loadUserData() {
            const stored = localStorage.getItem('iFrutasUser');
            if (stored) {
                userData = JSON.parse(stored);
                updateHeaderAddress();
                // Preencher campos do modal
                document.getElementById('user-name').value = userData.name || "";
                document.getElementById('addr-street').value = userData.street || "";
                document.getElementById('addr-num').value = userData.number || "";
                document.getElementById('addr-comp').value = userData.comp || "";
                document.getElementById('addr-ref').value = userData.ref || "";
            }
        }

        function saveAddress() {
            const name = document.getElementById('user-name').value;
            const street = document.getElementById('addr-street').value;
            const num = document.getElementById('addr-num').value;
            const comp = document.getElementById('addr-comp').value;
            const ref = document.getElementById('addr-ref').value;
            
            if (!name || !street || !num) {
                alert("Por favor, preencha Nome, Rua e N√∫mero.");
                return;
            }
            
            // Formatar endere√ßo para exibi√ß√£o
            const formatted = `${street}, ${num}`;

            // Atualizar objeto global
            userData = {
                name: name,
                street: street,
                number: num,
                comp: comp,
                ref: ref,
                formatted: formatted
            };

            // Salvar no navegador
            localStorage.setItem('iFrutasUser', JSON.stringify(userData));

            updateHeaderAddress();
            closeModal('address-modal');
        }

        function updateHeaderAddress() {
            if (userData.formatted) {
                document.getElementById('header-address').innerText = userData.formatted;
            } else {
                document.getElementById('header-address').innerText = "Selecionar Endere√ßo";
            }
        }

        // --- Renderiza√ß√£o ---
        function renderProducts() {
            const container = document.getElementById('product-list');
            container.innerHTML = products.map(p => {
                const time = Math.floor(Math.random() * (p.deliveryRange[1] - p.deliveryRange[0]) + p.deliveryRange[0]);
                return `
                <div class="product-card" onclick="openProduct(${p.id})">
                    <img src="${p.images[0]}" class="product-img" alt="${p.name}">
                    <div class="product-info">
                        <h3 class="product-title">${p.name}</h3>
                        <p class="product-desc-short">${p.benefits}</p>
                        <div class="product-meta">
                            <span class="product-price">R$ ${p.price.toFixed(2)}</span>
                            <span class="delivery-time">üïí ${time} min</span>
                        </div>
                    </div>
                </div>
                `
            }).join('');
        }

        // --- Modal Produto ---
        function openProduct(id) {
            currentProduct = products.find(p => p.id === id);
            currentQty = 1;
            
            document.getElementById('modal-img').src = currentProduct.images[0];
            document.getElementById('modal-title').innerText = currentProduct.name;
            document.getElementById('modal-price').innerText = `R$ ${currentProduct.price.toFixed(2)}`;
            document.getElementById('modal-benefits').innerText = currentProduct.benefits;
            document.getElementById('modal-qty').innerText = currentQty;
            document.getElementById('modal-obs').value = '';
            
            const time = Math.floor(Math.random() * (currentProduct.deliveryRange[1] - currentProduct.deliveryRange[0]) + currentProduct.deliveryRange[0]);
            document.getElementById('modal-delivery-time').innerText = `${time}-${time+10} min`;
            
            updateModalBtnPrice();
            document.getElementById('product-modal').classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            if (id === 'checkout-modal') {
                stopTimer();
                isPaymentPending = false; // Resetar se fechar o modal
            }
        }

        function changeQty(delta) {
            if (currentQty + delta >= 1) {
                currentQty += delta;
                document.getElementById('modal-qty').innerText = currentQty;
                updateModalBtnPrice();
            }
        }

        function updateModalBtnPrice() {
            const total = currentProduct.price * currentQty;
            document.getElementById('modal-btn-price').innerText = `R$ ${total.toFixed(2)}`;
        }

        function addToCart() {
            const obs = document.getElementById('modal-obs').value;
            const item = {
                product: currentProduct,
                qty: currentQty,
                obs: obs,
                totalPrice: currentProduct.price * currentQty
            };
            
            cart.push(item);
            closeModal('product-modal');
            updateCartUI();
        }

        // --- Carrinho ---
        function updateCartUI() {
            const cartBar = document.getElementById('cart-bar');
            const total = cart.reduce((acc, item) => acc + item.totalPrice, 0);
            
            document.getElementById('cart-bar-total').innerText = `R$ ${total.toFixed(2)}`;
            document.getElementById('cart-total-display').innerText = `R$ ${total.toFixed(2)}`;
            
            if (cart.length > 0) cartBar.classList.remove('hidden');
            else cartBar.classList.add('hidden');

            const cartContainer = document.getElementById('cart-items-container');
            if (cart.length === 0) {
                cartContainer.innerHTML = '<p style="text-align:center; margin-top: 40px; color:#999;">Sua sacola est√° vazia üõí</p>';
            } else {
                cartContainer.innerHTML = cart.map((item, index) => `
                    <div style="display:flex; gap:10px; margin-bottom:15px; border-bottom:1px solid #f0f0f0; padding-bottom:10px;">
                        <img src="${item.product.images[0]}" style="width:50px; height:50px; object-fit:cover; border-radius:4px;">
                        <div style="flex:1;">
                            <div style="display:flex; justify-content:space-between;">
                                <span style="font-weight:500;">${item.qty}x ${item.product.name}</span>
                                <span style="font-weight:bold;">R$ ${item.totalPrice.toFixed(2)}</span>
                            </div>
                            ${item.obs ? `<p style="font-size:0.75rem; color:#888;">Obs: ${item.obs}</p>` : ''}
                            <button onclick="removeFromCart(${index})" style="color:var(--primary); background:none; border:none; font-size:0.8rem; margin-top:5px; cursor:pointer;">Remover</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartUI();
            if(cart.length === 0) closeModal('cart-modal');
        }

        function clearCart() {
            cart = [];
            updateCartUI();
            closeModal('cart-modal');
        }

        function openCartModal() {
            document.getElementById('cart-modal').classList.add('active');
        }

        function openAddressModal() {
            document.getElementById('address-modal').classList.add('active');
        }

        // --- Checkout ---
        function goToCheckout() {
            if (!userData.formatted) {
                closeModal('cart-modal');
                openAddressModal();
                return;
            }
            
            closeModal('cart-modal');
            document.getElementById('checkout-modal').classList.add('active');
            
            // Exibir dados completos
            let fullAddr = `${userData.street}, ${userData.number}`;
            if(userData.comp) fullAddr += ` - ${userData.comp}`;
            if(userData.ref) fullAddr += ` (${userData.ref})`;

            document.getElementById('checkout-address-display').innerText = fullAddr;
            document.getElementById('checkout-name-display').innerText = userData.name;
            
            const total = cart.reduce((acc, item) => acc + item.totalPrice, 0);
            document.getElementById('checkout-total-display').innerText = `R$ ${total.toFixed(2)}`;
            
            document.getElementById('checkout-items-summary').innerHTML = cart.map(i => `${i.qty}x ${i.product.name}`).join(', ');

            isPaymentPending = false; // Resetar estado
            startTimer();
        }

        function startTimer() {
            let timeLeft = 600; 
            const timerEl = document.getElementById('payment-timer');
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerEl.innerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert("Tempo esgotado!");
                    closeModal('checkout-modal');
                }
                timeLeft--;
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); }

        // --- L√≥gica de Pagamento Atualizada (Visibilidade) ---

        function copyPixCode() {
            navigator.clipboard.writeText(pixCode).then(() => {
                alert("C√≥digo Pix copiado! V√° ao app do seu banco e pague.");
                // Marca que o usu√°rio iniciou o processo de pagamento
                isPaymentPending = true;
            }).catch(() => {
                alert("Erro ao copiar automaticamente. Tente o Link.");
            });
        }

        function clickPaymentLink() {
            // Marca que o usu√°rio iniciou o processo de pagamento
            isPaymentPending = true;
        }

        // Fun√ß√£o que detecta quando o usu√°rio sai e volta da aba/app
        function handleVisibilityChange() {
            if (document.hidden) {
                // Usu√°rio saiu do app/site
                if (isPaymentPending) {
                    leftAppTimestamp = Date.now();
                }
            } else {
                // Usu√°rio voltou ao app/site
                if (isPaymentPending) {
                    const timeAway = Date.now() - leftAppTimestamp;
                    
                    // Verifica se ficou fora pelo menos 3 segundos (tempo m√≠nimo pra abrir banco e pagar)
                    // Isso evita disparar se ele s√≥ trocou de aba acidentalmente
                    if (timeAway > 3000) {
                        closeModal('checkout-modal');
                        showLoading();
                        isPaymentPending = false; // Resetar
                    }
                }
            }
        }

        function showLoading() {
            const loading = document.getElementById('loading-screen');
            loading.classList.remove('hidden');
            
            // Simula verifica√ß√£o no servidor
            setTimeout(() => {
                loading.classList.add('hidden');
                showSuccess();
            }, 3000);
        }

        function showSuccess() {
            const success = document.getElementById('success-screen');
            const time = Math.floor(Math.random() * (45 - 25) + 25);
            document.getElementById('final-delivery-time').innerText = `${time}-${time+15}`;
            
            success.classList.remove('hidden');
            cart = []; 
            updateCartUI();
        }

    </script>
</body>
</html>
