<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iFrutas - As Melhores Frutas do Rio</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ea1d2c;
            --primary-dark: #b60f1b;
            --bg: #f7f7f7;
            --text: #3e3e3e;
            --text-light: #717171;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --radius: 12px;
            --success: #50a773;
            --transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: var(--text); padding-bottom: 90px; }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* --- Header & Search --- */
        header {
            background: var(--white);
            padding: 15px 20px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }

        .location-bar { cursor: pointer; display: flex; flex-direction: column; flex: 1; transition: var(--transition); }
        .location-bar:active { opacity: 0.6; }
        .location-label { font-size: 0.7rem; color: var(--primary); font-weight: bold; text-transform: uppercase; }
        .location-address { font-weight: 700; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; color: var(--text); }

        .search-container { position: relative; width: 100%; }
        .search-input { 
            width: 100%; padding: 12px 15px 12px 40px; border-radius: 25px; 
            border: 1px solid #eee; background: #f4f4f4; outline: none; font-size: 0.9rem;
            transition: var(--transition);
        }
        .search-input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(234, 29, 44, 0.1); }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #888; }

        .app-title {
            color: var(--primary); font-weight: 900; font-size: 1.5rem; text-align: center;
            margin: 15px 0; letter-spacing: -1px; animation: fadeIn 0.5s ease;
        }

        /* --- Cat√°logo --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 10px 20px; }
        h2 { font-size: 1.1rem; margin: 20px 0 15px; font-weight: 700; display: flex; justify-content: space-between; }

        .product-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; animation: fadeIn 0.6s ease; }
        @media(min-width: 768px) { .product-grid { grid-template-columns: repeat(4, 1fr); } }

        .product-card {
            background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow);
            overflow: hidden; cursor: pointer; position: relative;
            transition: var(--transition);
        }
        .product-card:active { transform: scale(0.96); }
        .product-card:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }

        .promo-badge {
            position: absolute; top: 10px; left: 10px; background: var(--primary);
            color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; z-index: 5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .time-badge {
            position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9);
            color: #333; padding: 4px 8px; border-radius: 12px; font-size: 0.65rem; font-weight: bold; z-index: 5;
            display: flex; align-items: center; gap: 3px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .product-img { width: 100%; height: 130px; object-fit: cover; }
        .product-info { padding: 10px; }
        .product-title { font-size: 0.85rem; font-weight: 500; height: 34px; overflow: hidden; margin-bottom: 5px; }
        
        .price-tag { display: flex; align-items: center; gap: 5px; }
        .old-price { text-decoration: line-through; color: #999; font-size: 0.75rem; }
        .current-price { color: var(--success); font-weight: 700; font-size: 0.95rem; }

        /* --- Avalia√ß√µes & Observa√ß√£o --- */
        .reviews-section { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .review-item { margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 8px; font-size: 0.8rem; }
        .review-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .stars { color: #ffb100; }
        .review-user { font-weight: bold; }

        .obs-container { margin-top: 15px; background: #fff8f8; padding: 10px; border-radius: 8px; border: 1px dashed #ddd; }
        .obs-label { font-size: 0.8rem; font-weight: bold; color: #555; margin-bottom: 5px; display: block; }
        .obs-input { 
            width: 100%; border: 1px solid #eee; border-radius: 6px; padding: 8px; 
            font-size: 0.85rem; outline: none; background: #fff; resize: none;
        }

        /* --- Carrinho & Bot√µes --- */
        .cart-bar {
            position: fixed; bottom: 0; width: 100%; background: white; padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1); z-index: 99;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .cart-bar.visible { transform: translateY(0); }

        .cart-item-box { 
            border: 1px solid #eee; border-radius: 12px; padding: 12px; margin-bottom: 15px;
            background: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.02); position: relative;
            animation: fadeIn 0.3s ease;
        }

        .btn-pay-item {
            width: 100%; background: var(--success); color: white; border: none;
            padding: 12px; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer;
            transition: var(--transition); box-shadow: 0 4px 6px rgba(80, 167, 115, 0.2);
        }
        .btn-pay-item:active { transform: scale(0.98); }

        /* --- Modais --- */
        .modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 1000; 
            display: flex; align-items: flex-end;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal.active { opacity: 1; pointer-events: auto; }
        
        .modal-content { 
            background: var(--white); width: 100%; max-height: 90%; 
            border-radius: 20px 20px 0 0; padding: 25px 20px; overflow-y: auto; 
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal.active .modal-content { transform: translateY(0); }

        .close-btn { float: right; font-size: 1.8rem; border: none; background: none; cursor: pointer; color: #999; line-height: 0.8; }
        
        /* Review Screen Specifics */
        .review-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; }
        .review-row.total { border: none; font-weight: 900; font-size: 1.1rem; margin-top: 10px; color: var(--primary); }
        .review-obs { font-size: 0.8rem; color: #666; font-style: italic; background: #eee; padding: 8px; border-radius: 6px; margin-top: 5px; }

        .hidden { display: none !important; }

        /* Helper for address form */
        .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .form-group { width: 100%; margin-bottom: 10px; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: bold; color: #555; margin-bottom: 5px; }
        .form-group input { width: 100%; background: white; border: 1px solid #ddd; padding: 12px; border-radius: 8px; font-size: 0.9rem; }
    </style>
</head>
<body>

    <header>
        <div class="header-top">
            <div class="location-bar" onclick="openModal('address-modal')">
                <span class="location-label">Entregar agora em (35-45 min)</span>
                <span class="location-address" id="header-address">üìç Selecionar Endere√ßo</span>
            </div>
            <button onclick="openModal('history-modal')" style="background:none; border:none; font-size: 1.5rem; cursor:pointer; transition: transform 0.2s;">üìã</button>
        </div>
        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" placeholder="Buscar frutas (ex: Manga, Jaca...)" onkeyup="filterProducts(this.value)">
        </div>
    </header>

    <div class="app-title">iFrutas üçé</div>

    <main class="container">
        <h2 id="section-title">Destaques da Regi√£o üìç</h2>
        <div class="product-grid" id="product-list"></div>
    </main>

    <div class="cart-bar" id="cart-bar">
        <div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <span id="cart-count" style="background: var(--primary); color: white; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.75rem; font-weight: bold;">0</span>
                <span style="font-weight: bold; font-size: 0.9rem;">Item(s) na sacola</span>
            </div>
            <span style="font-size: 0.7rem; color: #666;">Entrega estimada: 35-45 min</span>
        </div>
        <button class="btn-primary" onclick="openModal('cart-modal')" style="background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; box-shadow: 0 4px 10px rgba(234, 29, 44, 0.3);">Ver Sacola</button>
    </div>

    <div class="modal" id="product-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('product-modal')">√ó</button>
            <div style="position: relative;">
                <img src="" id="modal-img" style="width: 100%; height: 200px; object-fit: cover; border-radius: 12px; margin-bottom: 15px;">
                <span class="time-badge" style="top: 10px; right: 10px; position: absolute;">üõµ 35-45 min</span>
            </div>
            <h3 id="modal-title" style="font-size: 1.3rem;"></h3>
            <div class="price-tag" style="margin: 10px 0;">
                <span id="modal-old-price" class="old-price"></span>
                <span id="modal-current-price" class="current-price" style="font-size: 1.4rem;"></span>
            </div>
            <p id="modal-desc" style="font-size: 0.9rem; color: #666; margin-bottom: 20px; line-height: 1.4;"></p>
            
            <div class="reviews-section">
                <h4 style="margin-bottom: 10px;">Avalia√ß√µes</h4>
                <div id="modal-reviews"></div>
            </div>

            <div class="obs-container">
                <label class="obs-label">üìù Alguma observa√ß√£o?</label>
                <textarea id="obs-input" class="obs-input" rows="2" placeholder="Ex: Fruta mais madura, tirar casca, entregar no port√£o..."></textarea>
            </div>

            <div style="margin-top: 20px; display: flex; gap: 10px; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px; border: 1px solid #ddd; padding: 10px; border-radius: 8px;">
                    <button onclick="changeQty(-1)" style="border:none; background:none; font-size: 1.2rem; color: var(--primary); font-weight: bold;">-</button>
                    <span id="modal-qty" style="font-weight: bold;">1</span>
                    <button onclick="changeQty(1)" style="border:none; background:none; font-size: 1.2rem; color: var(--primary); font-weight: bold;">+</button>
                </div>
                <button onclick="addToCart()" style="flex: 1; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; box-shadow: 0 4px 10px rgba(234, 29, 44, 0.3);">Adicionar √† Sacola</button>
            </div>
        </div>
    </div>

    <div class="modal" id="cart-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('cart-modal')">√ó</button>
            <h3 style="margin-bottom: 5px;">Sua Sacola üõí</h3>
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 20px;">Revise seus itens antes de pagar.</p>
            <div id="cart-items-container"></div>
        </div>
    </div>

    <div class="modal" id="review-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('review-modal')">√ó</button>
            <h3 style="margin-bottom: 20px; color: var(--text);">Resumo do Pedido üßæ</h3>
            
            <div style="background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed #ccc;">
                    <p style="font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: bold;">Entregar em:</p>
                    <p id="review-address" style="font-weight: bold; font-size: 0.95rem; display:flex; align-items:center; gap:5px;">üìç Carregando...</p>
                    <p id="review-name" style="font-size: 0.85rem; color: #555; margin-top: 3px;">üë§ Carregando...</p>
                    <p style="font-size: 0.8rem; color: var(--success); font-weight: bold; margin-top: 5px;">‚è±Ô∏è Entrega estimada: 35-45 min</p>
                </div>

                <div id="review-product-details">
                    </div>
            </div>

            <button onclick="finalizeReview()" style="width: 100%; background: var(--success); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; font-size: 1rem; box-shadow: 0 4px 10px rgba(80, 167, 115, 0.3);">‚úÖ Confirmar e Pagar</button>
        </div>
    </div>

    <div class="modal" id="history-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('history-modal')">√ó</button>
            <h3 style="margin-bottom: 20px;">Meus Pedidos üìã</h3>
            <div id="history-container"></div>
        </div>
    </div>

    <div class="modal" id="address-modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('address-modal')">√ó</button>
            <h3>Onde entregamos? üè†</h3>
            <div style="margin-top: 20px;">
                <div class="form-group">
                    <label>Seu Nome</label>
                    <input type="text" id="user-name" placeholder="Ex: Jo√£o da Silva">
                </div>
                
                <div class="form-row">
                    <div class="form-group" style="flex: 3;">
                        <label>Rua</label>
                        <input type="text" id="addr-street" placeholder="Nome da Rua">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>N√∫mero</label>
                        <input type="text" id="addr-num" placeholder="N¬∫">
                    </div>
                </div>

                <div class="form-group">
                    <label>Complemento <span style="font-weight:normal; color:#888;">(Opcional)</span></label>
                    <input type="text" id="addr-comp" placeholder="Ex: Apt 101, Fundos">
                </div>

                <div class="form-group">
                    <label>Ponto de Refer√™ncia <span style="font-weight:normal; color:#888;">(Opcional)</span></label>
                    <input type="text" id="addr-ref" placeholder="Ex: Ao lado da padaria">
                </div>

                <button onclick="saveAddress()" style="width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 8px; font-weight: bold; margin-top: 10px;">Salvar Endere√ßo</button>
            </div>
        </div>
    </div>

    <div class="modal" id="checkout-modal">
        <div class="modal-content" style="text-align: center;">
            <button class="close-btn" onclick="closeModal('checkout-modal')">√ó</button>
            <h3>Finalizar Pagamento</h3>
            <p id="checkout-item-name" style="font-weight: bold; margin: 15px 0;"></p>
            
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Logo%E2%80%94pix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg/2560px-Logo%E2%80%94pix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg.png" width="80" style="margin-bottom: 10px;">
            <div style="background: #f4f4f4; padding: 15px; border-radius: 8px; margin-bottom: 15px; animation: popIn 0.5s ease;">
                <img id="checkout-qr" src="" style="width: 180px; height: 180px; margin-bottom: 10px;">
                <p style="font-size: 0.8rem; color: #666;">Pague e retorne para confirmar</p>
            </div>

            <button onclick="copyPix()" style="width: 100%; background: #333; color: white; border: none; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-weight: bold;">üìã Copiar C√≥digo Pix</button>
            <a id="checkout-link" href="#" target="_blank" onclick="simulatePaymentStart()" style="display: block; width: 100%; background: #00d700; color: white; text-decoration: none; padding: 12px; border-radius: 8px; font-weight: bold;">üîó Abrir Link de Pagamento</a>
        </div>
    </div>

    <div id="loading-overlay" class="hidden" style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(234,29,44,0.95); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;">
        <div style="width: 50px; height: 50px; border: 5px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <h3 style="margin-top: 20px;">Processando seu Pix...</h3>
    </div>

    <script>
        // --- DATA ---
        const products = [
            {
                id: 1, name: "Jaca Dura Premium", price: 20.00, oldPrice: 25.00,
                img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRav5c9icx32NBrS6E--h_GOloEZH_vZcvOf4VTc_zLxEPDLGHzHbi3VOw&s=10",
                desc: "Jaca de √≥tima qualidade, gominhos crocantes e muito doces.",
                pixCode: "00020126580014BR.GOV.BCB.PIX01361c729f04-a046-4310-bdf5-1ead5d34bfc5520400005303986540520.005802BR5925Wendel dos Santos Oliveir6009SAO PAULO621405100JMyqeB0Mz630473B5",
                pixLink: "https://nubank.com.br/cobrar/1ku07b/693b9dab-a751-438b-9db5-871e056167c6",
                reviews: [{u: "Ricardo M.", s: 5, t: "Melhor jaca que j√° comi no Rio!"}, {u: "Ana P.", s: 4, t: "Muito boa, chegou bem geladinha."}]
            },
            {
                id: 2, name: "Jaca Mole Selecionada", price: 20.00, oldPrice: 28.00,
                img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSZDNoz0ZN-3wuE8PQPN8oG0WK7dPcbTiCJ3J0w7eFIQbMMgBOyIKLJDss&s=10",
                desc: "Textura cremosa, ideal para quem gosta de jaca bem madura.",
                pixCode: "00020126580014BR.GOV.BCB.PIX01361c729f04-a046-4310-bdf5-1ead5d34bfc5520400005303986540520.005802BR5925Wendel dos Santos Oliveir6009SAO PAULO621405100JMyqeB0Mz630473B5",
                pixLink: "https://nubank.com.br/cobrar/1ku07b/693b9dab-a751-438b-9db5-871e056167c6",
                reviews: [{u: "Marcos T.", s: 5, t: "Perfeita para comer de colher."}]
            },
            {
                id: 3, name: "Saco com 10 Mangas Espada", price: 5.00, oldPrice: 12.00, promo: "PROMO√á√ÉO",
                img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQmYk_HY_3VmSD04r2F-Z-I526sAD60xgNzngZJNQnvj-FgsphJ8aI28dE&s=10",
                desc: "Mangas espada selecionadas. Saco fechado com 10 unidades.",
                pixCode: "00020126580014BR.GOV.BCB.PIX01361c729f04-a046-4310-bdf5-1ead5d34bfc552040000530398654045.005802BR5925Wendel dos Santos Oliveir6009SAO PAULO62140510JDQ3sb0SN8630497E5",
                pixLink: "https://nubank.com.br/cobrar/1ku07b/693baf36-28cb-4b93-97a6-d054b2d70ee3",
                reviews: [{u: "Carla S.", s: 5, t: "Pelo pre√ßo, a qualidade √© absurda!"}, {u: "Pedro J.", s: 5, t: "Docinhas demais."}]
            },
            {
                id: 4, name: "Saco com 20 Mangas Espada", price: 10.00, oldPrice: 20.00, promo: "MELHOR PRE√áO",
                img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTyA-o71zixhlPoztyYsnOp0qFhUggWxOUSZ2SE7iBqySzB73njOWh9kIw&s=10",
                desc: "Combo fam√≠lia com 20 mangas espada. Super doces.",
                pixCode: "00020126580014BR.GOV.BCB.PIX01361c729f04-a046-4310-bdf5-1ead5d34bfc5520400005303986540510.005802BR5925Wendel dos Santos Oliveir6009SAO PAULO62140510SdE6QFAylY63042B3C",
                pixLink: "https://nubank.com.br/cobrar/1ku07b/693bb002-4b9b-4a28-9323-7cde9e373115",
                reviews: [{u: "Joana G.", s: 5, t: "Valeu muito a pena, vieram todas perfeitas."}]
            },
            {
                id: 5, name: "Kit 2 Abacaxis P√©rola", price: 5.00, oldPrice: 10.00, promo: "2 POR 5",
                img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQJVQgq5FCLAQ7Ta4G2Qw9yVOljcMJM1wkHZCYhVxrq5GmKCtYhdyKAjWU&s=10",
                desc: "Abacaxi P√©rola bem maduro e doce. Direto do produtor.",
                pixCode: "00020126580014BR.GOV.BCB.PIX01361c729f04-a046-4310-bdf5-1ead5d34bfc552040000530398654045.005802BR5925Wendel dos Santos Oliveir6009SAO PAULO62140510JDQ3sb0SN8630497E5",
                pixLink: "https://nubank.com.br/cobrar/1ku07b/693baf36-28cb-4b93-97a6-d054b2d70ee3",
                reviews: [{u: "Felipe L.", s: 5, t: "Melhor abacaxi da regi√£o!"}]
            },
            {
                id: 6, name: "Combo 5 Abacaxis P√©rola", price: 10.00, oldPrice: 25.00, promo: "OFERTA",
                img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQJVQgq5FCLAQ7Ta4G2Qw9yVOljcMJM1wkHZCYhVxrq5GmKCtYhdyKAjWU&s=10",
                desc: "Ideal para sucos e sobremesas. 5 unidades grandes.",
                pixCode: "00020126580014BR.GOV.BCB.PIX01361c729f04-a046-4310-bdf5-1ead5d34bfc5520400005303986540510.005802BR5925Wendel dos Santos Oliveir6009SAO PAULO62140510SdE6QFAylY63042B3C",
                pixLink: "https://nubank.com.br/cobrar/1ku07b/693bb002-4b9b-4a28-9323-7cde9e373115",
                reviews: [{u: "Beatriz R.", s: 4, t: "Muito bom, entregador foi super atencioso."}]
            }
        ];

        // --- STATE ---
        let cart = [];
        let history = JSON.parse(localStorage.getItem('iFrutasHistory') || '[]');
        let currentProduct = null;
        let currentQty = 1;
        let isWaitingPayment = false;

        // --- CORE FUNCTIONS ---
        function renderProducts(list = products) {
            const container = document.getElementById('product-list');
            container.innerHTML = list.map(p => `
                <div class="product-card" onclick="openProduct(${p.id})">
                    ${p.promo ? `<div class="promo-badge">${p.promo}</div>` : ''}
                    <div class="time-badge">üïí 35-45 min</div>
                    <img src="${p.img}" class="product-img">
                    <div class="product-info">
                        <div class="product-title">${p.name}</div>
                        <div class="price-tag">
                            <span class="old-price">R$ ${p.oldPrice.toFixed(2)}</span>
                            <span class="current-price">R$ ${p.price.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterProducts(query) {
            const filtered = products.filter(p => p.name.toLowerCase().includes(query.toLowerCase()));
            renderProducts(filtered);
            document.getElementById('section-title').innerText = query ? `Resultados para "${query}"` : "Destaques da Regi√£o üìç";
        }

        function openProduct(id) {
            currentProduct = products.find(p => p.id === id);
            currentQty = 1;
            document.getElementById('modal-img').src = currentProduct.img;
            document.getElementById('modal-title').innerText = currentProduct.name;
            document.getElementById('modal-old-price').innerText = `R$ ${currentProduct.oldPrice.toFixed(2)}`;
            document.getElementById('modal-current-price').innerText = `R$ ${currentProduct.price.toFixed(2)}`;
            document.getElementById('modal-desc').innerText = currentProduct.desc;
            document.getElementById('modal-qty').innerText = currentQty;
            document.getElementById('obs-input').value = ""; // Limpa observa√ß√£o anterior
            
            document.getElementById('modal-reviews').innerHTML = currentProduct.reviews.map(r => `
                <div class="review-item">
                    <div class="review-header">
                        <span class="review-user">${r.u}</span>
                        <span class="stars">${'‚òÖ'.repeat(r.s)}</span>
                    </div>
                    <p style="color:#666; font-style:italic;">"${r.t}"</p>
                </div>
            `).join('');

            openModal('product-modal');
        }

        function changeQty(delta) {
            currentQty = Math.max(1, currentQty + delta);
            document.getElementById('modal-qty').innerText = currentQty;
        }

        function addToCart() {
            const obs = document.getElementById('obs-input').value;
            cart.push({ ...currentProduct, qty: currentQty, cartId: Date.now(), obs: obs });
            updateCartUI();
            closeModal('product-modal');
        }

        function updateCartUI() {
            const count = cart.length;
            const cartBar = document.getElementById('cart-bar');
            
            if (count > 0) {
                cartBar.classList.remove('hidden');
                setTimeout(() => cartBar.classList.add('visible'), 10);
            } else {
                cartBar.classList.remove('visible');
                setTimeout(() => cartBar.classList.add('hidden'), 400);
            }

            document.getElementById('cart-count').innerText = count;

            const container = document.getElementById('cart-items-container');
            container.innerHTML = cart.map((item, idx) => `
                <div class="cart-item-box">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${item.qty}x ${item.name}</strong>
                        <span style="color:var(--success); font-weight:bold;">R$ ${(item.price * item.qty).toFixed(2)}</span>
                    </div>
                    ${item.obs ? `<p style="font-size:0.75rem; color:#666; margin-top:4px;">üìù Obs: ${item.obs}</p>` : ''}
                    <button class="btn-pay-item" onclick="openReviewModal(${idx})">Revisar e Pagar</button>
                    <button onclick="removeFromCart(${idx})" style="width:100%; background:none; border:none; color:#999; margin-top:8px; font-size:0.7rem; cursor:pointer;">Remover da sacola</button>
                </div>
            `).join('');
        }

        function removeFromCart(idx) {
            cart.splice(idx, 1);
            updateCartUI();
            if(cart.length === 0) closeModal('cart-modal');
        }

        // --- REVIEW & CHECKOUT LOGIC ---
        function openReviewModal(idx) {
            const item = cart[idx];
            currentProduct = item; // Para uso no checkout

            // Dados do Endere√ßo
            const savedAddr = localStorage.getItem('iFrutasAddr');
            const savedName = localStorage.getItem('iFrutasName') || "Cliente";

            if(!savedAddr) {
                alert("Por favor, adicione um endere√ßo antes de prosseguir.");
                closeModal('cart-modal');
                openModal('address-modal');
                return;
            }

            document.getElementById('review-address').innerHTML = `üìç ${savedAddr}`;
            document.getElementById('review-name').innerHTML = `üë§ ${savedName}`;
            
            // Detalhes do produto
            const total = item.price * item.qty;
            document.getElementById('review-product-details').innerHTML = `
                <div class="review-row">
                    <span>${item.qty}x ${item.name}</span>
                    <span>R$ ${total.toFixed(2)}</span>
                </div>
                ${item.obs ? `<div class="review-obs">" ${item.obs} "</div>` : ''}
                <div class="review-row total">
                    <span>Total a Pagar</span>
                    <span>R$ ${total.toFixed(2)}</span>
                </div>
            `;

            closeModal('cart-modal');
            openModal('review-modal');
        }

        function finalizeReview() {
            closeModal('review-modal');
            startCheckout();
        }

        function startCheckout() {
            const item = currentProduct;
            document.getElementById('checkout-item-name').innerText = `${item.qty}x ${item.name}`;
            document.getElementById('checkout-qr').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(item.pixCode)}`;
            document.getElementById('checkout-link').href = item.pixLink;
            
            openModal('checkout-modal');
        }

        function copyPix() {
            navigator.clipboard.writeText(currentProduct.pixCode);
            alert("C√≥digo copiado! Pague no seu banco.");
            simulatePaymentStart();
        }

        function simulatePaymentStart() {
            isWaitingPayment = true;
        }

        // Detectar quando o usu√°rio volta para a aba ap√≥s sair para pagar
        document.addEventListener("visibilitychange", () => {
            if (!document.hidden && isWaitingPayment) {
                confirmPayment();
            }
        });

        function confirmPayment() {
            isWaitingPayment = false;
            document.getElementById('loading-overlay').classList.remove('hidden');
            
            setTimeout(() => {
                document.getElementById('loading-overlay').classList.add('hidden');
                
                // Salva no hist√≥rico
                const order = {
                    id: Math.floor(Math.random() * 10000),
                    name: currentProduct.name,
                    date: new Date().toLocaleString(),
                    price: currentProduct.price * currentProduct.qty,
                    status: "Em Preparo üõµ"
                };
                history.unshift(order);
                localStorage.setItem('iFrutasHistory', JSON.stringify(history));

                // Remove do carrinho o item pago
                cart = cart.filter(i => i.cartId !== currentProduct.cartId);
                updateCartUI();
                
                closeModal('checkout-modal');
                // Pequeno delay para UX
                setTimeout(() => {
                    alert("Pagamento Confirmado! Seu pedido chegar√° em aprox. 40min.");
                    openModal('history-modal');
                    updateHistoryUI();
                }, 300);
            }, 3000);
        }

        function updateHistoryUI() {
            const container = document.getElementById('history-container');
            if(history.length === 0) {
                container.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>Voc√™ ainda n√£o fez pedidos.</p>";
                return;
            }
            container.innerHTML = history.map(h => `
                <div class="cart-item-box" style="border-left: 4px solid var(--primary); animation: fadeIn 0.4s ease;">
                    <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#888;">
                        <span>Pedido #${h.id}</span>
                        <span>${h.date}</span>
                    </div>
                    <p style="margin:5px 0; font-weight:bold;">${h.name}</p>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                        <span style="color:var(--success); font-weight:bold;">R$ ${h.price.toFixed(2)}</span>
                        <span style="background:#fff3f3; color:var(--primary); padding:3px 8px; border-radius:4px; font-size:0.7rem; font-weight:bold;">${h.status}</span>
                    </div>
                </div>
            `).join('');
        }

        // --- UTILS ---
        function openModal(id) { document.getElementById(id).classList.add('active'); if(id === 'history-modal') updateHistoryUI(); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        
        function saveAddress() {
            const name = document.getElementById('user-name').value;
            const street = document.getElementById('addr-street').value;
            const num = document.getElementById('addr-num').value;
            const comp = document.getElementById('addr-comp').value;
            const ref = document.getElementById('addr-ref').value;

            if(!name || !street || !num) return alert("Por favor, preencha Nome, Rua e N√∫mero.");

            // Formata o endere√ßo completo para salvar
            let fullAddr = `${street}, ${num}`;
            if(comp) fullAddr += ` - ${comp}`;
            if(ref) fullAddr += ` (${ref})`;
            
            document.getElementById('header-address').innerText = `üìç ${street}, ${num}`;
            localStorage.setItem('iFrutasAddr', fullAddr);
            localStorage.setItem('iFrutasName', name);
            closeModal('address-modal');
        }

        // --- INIT ---
        window.onload = () => {
            renderProducts();
            const savedAddr = localStorage.getItem('iFrutasAddr');
            if(savedAddr) {
                // Se j√° tem salvo, mostra resumido no header (pegando a primeira parte da string se for longa)
                // Mas aqui vamos simplificar e mostrar "Seu Endere√ßo" ou o salvo
                document.getElementById('header-address').innerText = `üìç ${savedAddr.split(',')[0]}...`;
            }
            else {
                setTimeout(() => openModal('address-modal'), 1500);
            }
        };

        // Estilos para anima√ß√£o spinner
        const style = document.createElement('style');
        style.innerHTML = `@keyframes spin { to { transform: rotate(360deg); } }`;
        document.head.appendChild(style);

    </script>
</body>
</html>
